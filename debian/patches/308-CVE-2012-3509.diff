#! /bin/sh /usr/share/dpatch/dpatch-run
## 308-CVE-2012-3509.diff by Florian Weimer <fweimer@redhat.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: From: Florian Weimer <fweimer@redhat.com>
## DP: Subject: Fix PR other/54411: integer overflow in objalloc_alloc.
## DP: Bug: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=54411
## DP: Origin: http://gcc.gnu.org/viewcvs?root=gcc&view=rev&rev=191413
## DP: 
## DP: 2012-09-18  Florian Weimer  <fweimer@redhat.com>
## DP: 
## DP: 	PR other/54411
## DP: 	* objalloc.h (objalloc_alloc): Do not use fast path on wraparound.
## DP: 
## DP: 2012-09-18  Florian Weimer  <fweimer@redhat.com>
## DP: 
## DP: 	PR other/54411
## DP: 	* objalloc.c (_objalloc_alloc): Add overflow check covering
## DP: 	alignment and CHUNK_HEADER_SIZE addition.

--- a/include/objalloc.h
+++ b/include/objalloc.h
@@ -1,5 +1,5 @@
 /* objalloc.h -- routines to allocate memory for objects
-   Copyright 1997, 2001 Free Software Foundation, Inc.
+   Copyright 1997-2012 Free Software Foundation, Inc.
    Written by Ian Lance Taylor, Cygnus Solutions.
 
 This program is free software; you can redistribute it and/or modify it
@@ -91,7 +91,7 @@
      if (__len == 0)							\
        __len = 1;							\
      __len = (__len + OBJALLOC_ALIGN - 1) &~ (OBJALLOC_ALIGN - 1);	\
-     (__len <= __o->current_space					\
+     (__len != 0 && __len <= __o->current_space				\
       ? (__o->current_ptr += __len,					\
 	 __o->current_space -= __len,					\
 	 (void *) (__o->current_ptr - __len))				\
--- b/libiberty/objalloc.c
+++ a/libiberty/objalloc.c
@@ -1,5 +1,5 @@
 /* objalloc.c -- routines to allocate memory for objects
-   Copyright 1997 Free Software Foundation, Inc.
+   Copyright 1997-2012 Free Software Foundation, Inc.
    Written by Ian Lance Taylor, Cygnus Solutions.
 
 This program is free software; you can redistribute it and/or modify it
@@ -112,8 +112,10 @@
 /* Allocate space from an objalloc structure.  */
 
 PTR
-_objalloc_alloc (struct objalloc *o, unsigned long len)
+_objalloc_alloc (struct objalloc *o, unsigned long original_len)
 {
+  unsigned long len = original_len;
+
   /* We avoid confusion from zero sized objects by always allocating
      at least 1 byte.  */
   if (len == 0)
@@ -121,6 +123,11 @@
 
   len = (len + OBJALLOC_ALIGN - 1) &~ (OBJALLOC_ALIGN - 1);
 
+  /* Check for overflow in the alignment operation above and the
+     malloc argument below. */
+  if (len + CHUNK_HEADER_SIZE < original_len)
+    return NULL;
+
   if (len <= o->current_space)
     {
       o->current_ptr += len;
